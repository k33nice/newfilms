<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <style>
        body{width: 50%;margin: 0 auto;}
        form {display: inline-block; margin: 0.5em;}
        ul{list-style: none;}
        span{margin: 0 0.6em;}
        span.delete{border:1px solid #000;border-radius: 5px;cursor: pointer;}
        span.delete:hover{border-radius: 7px;background: #ccc;}
        span.delete:active{background: #f00;}
        span.onePage{border-bottom:1px solid #000;cursor: pointer;}
        span.onePage:hover{background: #ccc;}
        span.onePage:active{background: #f00;}
        a{border-bottom:1px solid #ccc;}
        .active{font-size: 1.3em;}
        .pagination{display: block;}
        .searched {background-color:#eee;}
        #message{color: #0f0;}
    </style>
</head>
<body>
    <nav>
        <a href="/">Главная</a>
        <a href="/import/">Импорт</a>
    </nav>
    <input type="submit" class="create" name="add-request" value="добавить">
    <form class="search"  onsubmit="return filmsGrid();">
        <input type="text" value="" name="search" />
        <input type="submit" name="searchButton" value="Search" />
    </form>
    <select id="limit">
        <option>7</option>
        <option>10</option>
        <option>all</option>
    </select>
    <div class="pagination"></div>
    <div id="handler"></div>
    <div class="a"></div>
    <div id="message"></div>
    <script src="/static/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script>
        /**
         * URL parser
         * @type {[type]}
         */
        var parser = document.createElement('a');
            parser.href = document.URL;

            parser.protocol;
            parser.hostname;
            parser.port;
            parser.pathname;
            parser.search;
            parser.hash;
            parser.host;

        var url = parser.pathname;
        /* End URl parser */

        $("#limit").change(function(){
            $(".a").empty();
            $(".pagination").empty();
            indexFilms();
        });

        function indexFilms() {
            $.getJSON("/api/films/", function(dataResult) {
                var limit = $('#limit').val();
                var pageCount = Math.ceil(dataResult.TotalCount/limit);
                $('.pagination').text('Page:');
                for (var i=1; i<=pageCount; i++) {
                    var span = '<span class="onePage">'+i+'</span>'
                    $(span).appendTo('.pagination');
                }
                    filmsGrid();
                $('.onePage').click(function() {
                    page = $(this).text();
                    $('.onePage').removeClass('active');
                    $('.a').empty();
                    filmsGrid(page);
                });
            });
            return false;
        }

        function filmsGrid(page) {
            if ( !page ) page=1;
            var search = $('[name=search]', $('.search')).val();
            var limit = $('#limit').val();
            var sortOrder = 'desc';
            var params;
            var offset = (page-1)*limit;
            $('.onePage').eq(page-1).addClass('active');

            if(limit === 'all') {
                limit=100000;
                offset= 0;
                $('.pagination').empty();
            }
            if (search.length) {
                params = { Limit: limit, Search: search};
            } else {
                params = { Limit: limit, Offset: offset };
            };

            $.getJSON(
                "/api/films",
                params,
                function(dataResult) {
                    var films = dataResult.Films;
                    var grid = '';
                    $.each(films, function(key, film) {
                        grid +=
                            "<li id='" + film.Id + "'><a href='"+film.Id +"'><span>"+ film.Name + "</span></a>"+ "</li>"
                    });

                    $("<ul/>", {
                        "class": "films",
                        html: grid
                    }).appendTo("div.a");
                    if (search.length) {
                        $('ul.films li').each(function(){
                            $(this).addClass('searched');
                        });
                    }
                });
            $(".search").submit(function() {
                $(".pagination").empty();
                $(".a").empty();
            });
            return false;
        }

        // init create film
        $("input[name=add-request]").one("click",function() {
            createFilm();
        });

        function showFilm(id) {
            $('.pagination').empty();
            $.getJSON("/api/films/" + id, function(dataResult) {
                var film = dataResult.Film; // rename to film
                var html =
                    "<li id='" + film.Id + "'>"+
                            "<span>"+film.Name+"</span><span>"+film.Year+"</span><span>"+film.Format+"</span>"+
                            "<span>"+film.Stars+"</span>"+
                            "<span class='delete'>DELETE</span>"+
                   "</li>";

                $("<ul/>", {
                    "class": "films",
                    html: html
                }).appendTo("div.a");

                // init delete action
                $(document).on('click', 'span.delete', function() {
                    $.ajax({
                        url: '/api/films/'+film.Id,
                        type: 'delete',
                        success: function() {
                            $("#message").text("deleted");
                        }
                    });
                });
            });
            $('input').remove('.create');
        }

        // function deleteFilm(id) {

        // }

        function createFilm() {
            $('.pagination').empty();
            $('<form class="add" onsubmit="return postFilm();"></form>').appendTo('#handler');
            $('<input name="Name" type="text" value="title">').appendTo('.add');
            $('<input name="Year" type="text" value="year">').appendTo('.add');
            $('<input name="Format" type="text" value="format">').appendTo('.add');
            $('<input name="ActorName" type="text" value="actors">').appendTo('.add');
            $('<input type="submit" vlaue="добавить">').appendTo('.add');

            /*Clear inputs*/
            $('input:text').bind('focus', function() {
                $(this).val('');
            });

            $(".add").submit(function() {
                $(".films").empty();
            });
        }

        function postFilm() {
            var data = $('.add').serialize();
            $.ajax({
                url: '/api/films/',
                type: 'post',
                data: data,
                success: function(data) {
                    $('.a').html(data);
                    $('#message').text('create successful');
                }
            });
            return false;
        }

        /*function updateFile(id) {

        }*/

        function importFilm() {
            $('.pagination').empty();
            $('<form onsubmit="return uploadFile();" id="upload"></form>').appendTo('#handler');
            $('<input id="file" name="file", type="file" /><input type="submit" value="upload">').appendTo('#upload');
            $('<form onsubmit="return importFile();" id="import"></form>').appendTo('#handler');
            $('<input type="submit" value="import">').appendTo('#import');
        }

        function uploadFile() {
            var file_data = $('#file').prop('files')[0];
            var form_data = new FormData();
            form_data.append('file', file_data)
            $.ajax({
                    url: '../upload.php',
                    dataType: 'text',
                    contentType: false,
                    processData: false,
                    data: form_data,
                    type: 'post',
                    success: function(){
                        $("#message").text("upload successful")
                    }
            });
            return false;
        }

        function importFile() {
            $.ajax({
                url: '/api/films/import/',
                type: 'post',
                success: function() {
                    $('#message').text('import successful')
                }
            });
            return false;
        }

        function init() {
            if ( url == '/' ) {
                indexFilms();
            } else if ( url == '/import/' ) {
                $('#limit').remove();
                importFilm();
            } else if ( matched = url.match(/\/(\d+)/) ) {
                $('#limit').remove();
                var id = matched[1];
                showFilm(id);
            }
        }

        $(document).ready(init);

    </script>
</body>
</html>